---
title: 网页请求过程
date: 2018-08-18
---
这是一篇根据自己对网页浏览过程理解的总结。一个浏览网页的过程涉及到了方方面面，希望能将自己理解的尽可能记录总结下来，主要为了以下两点：
一是通过总结网页请求过程发现易被攻击的方面并找到理解对应的防范方法，让自己在以后开发中更加注意这些方面来提高网页的安全性；
二是找到可以提高网络性能的地方，提高用户体验。

<!-- more -->

本文将以一个用户在家里第一次上网访问 www.baidu.com 为例对用户在浏览器中输入这个 URL 后到整个网页呈现给用户的这个过程进行剖析。
总体来说主要分为以下过程：
1. 主机使用 UDP 数据报向 DNS 服务器发送请求解析 www.baidu.com 对应的IP地址
    - 因用户是第一次上网，主机要先获取自己的动态 IP 地址及 DNS 服务器 IP 地址；
    - 获取 DNS 服务器IP地址后，主机要与其通信要先获取其 MAC 地址；
2. 主机与 www.baidu.com 对应 IP 地址的服务器建立 TCP 连接发起 HTTP 请求获得 HTML 文件
3. 浏览器解析渲染 HTML 文件
4. 主机继续请求其中引入的外部文件，浏览器根据外部文件继续渲染 HTML 文件以呈现整个网页给用户

### DHCP 获取动态 IP
局域网广播到 DHCP 服务器获取动态 IP 地址，并获取默认路由地址及 DNS 服务器地址。

1. 客户机以 0.0.0.0 为源 IP 地址，255.255.255.255 为目标地址广播，广播信息包含客户机的 MAC 地址及计算机名称
2. DHCP 服务器收到广播信息后，从 IP 池中选出空闲的IP地址，并以 255.255.255.255 为目标地址广播，广播信息还包含子网掩码、默认路由、租约期限及 DHCP 的服务器 IP 地址。
3. 同一个网络中可能会存在多个 DHCP 服务器，客户机将使用接收到的第一个 DHCP 服务器消息中的IP地址，并以 0.0.0.0 为源 IP 地址，255.255.255.255 为目标地址广播发送 ACK 信息，广播信息包含选择的 IP 地址信息。
4. 被选中的 DHCP 服务器收到客户机发送的 DHCP 请求后，广播 ACK 消息向客户机及其他 DHCP 服务器确认该客户机可以使用其分配的 IP 地址，其他 DHCP 服务器收到消息后将收回之前分配的 IP 地址，客户机收到 ACK 消息后便可以将分配到的IP地址和网卡绑定。

如果是使用自动分配方式，第一次配置了IP地址之后便可以在合约期内一直使用该IP地址，一般会在合约期的50%时进行续约请求；如果使用动态分配方式，每次登录都要重新向DHCP服务器请求获取动态IP。

### ARP 请求获取 DNS 服务器的 MAC 地址
ARP 协议是以太网等数据链路层的基础协议，负责完成 IP 地址到硬件地址的映射。
以太网协议规定，同一个局域网中的一台主机要和另一台主机进行通信，必须知道目标主机的 MAC 地址。
1. 当主机在本机的 ARP 缓存表中没有找到目标 IP 的 MAC 地址，则广播发送 ARP 请求，请求解析 DNS 服务器的 MAC 地址。
2. 当 DNS 服务器收到 ARP 请求后，返回其 MAC 地址。并根据请求主机的 IP 地址和 MAC 地址建立 ARP 表。
3. 客户机收到来自 DNS 服务器的 ARP 响应后同样将 DNS 的 IP 地址和 MAC 地址的对应关系记录下来以建立 ARP 表。

### 像 DNS 服务器请求获取目标网址域名对应IP
1. 当主机需要向 DNS 服务器发送请求，首先在浏览器缓存中查找是否有目标网址的 IP 映射，若有则可以直接进行网络请求。
2. 若浏览器缓存中找不到对应的IP映射，操作系统则会在本机的 hosts 文件中查找目标网址的 IP 地址，找到则直接调用这个 IP 映射完成域名解析，并直接进行网络请求。
3. 当主机在本机 hosts 文件中找不到请求网址的IP地址，主机则需要向本地DNS服务器进行域名解析请求，若本地 DNS 服务器找到对应 IP 则返回。
4. 本地 DNS 服务器有可能是默认路由也有可能是ISP提供的 DNS 服务器，当其在本地缓存中找不到对应的 IP 映射时，便向根域名服务器进行 DNS 请求。全球的根域名服务器地址的数量被限制为 13 个，使用任播技术使得实际上的根域名服务器数量大大增加。
5. 之后的请求便是迭代的过程：
   - 根域名服务器会返回请求域名对应的权威顶级域名 DNS 服务器的 IP 并返回到本地 DNS 服务器，本地 DNS 服务器向对应的顶级域名 DNS 服务器进行 DNS 请求。仅被收录的顶级域名对应的权威顶级域名服务器能被根域名服务器查出。
   - 顶级服务器会返回请求域名对应的二级域名 DNS 服务器的 IP 并返回到本地 DNS 服务，本地 DNS 服务器向对应的二级域名 DNS 服务器进行 DNS 请求。
  如此重复下去直到本地 DNS 服务器查询到最终结果并返回给主机，此时主机才能通过域名访问目标网站。
  
### 主机跟目标主机建立 TCP 连接并发起 HTTP 请求获取网页内容
HTTP 协议是基于 TCP/IP 协议，TPC 协议提供可靠的连接服务，连接需要通过三次握手进行初始化。
1. 第一次握手:建立连接。客户端发送连接请求报文段，置 SYN 为 1，Seq 为 X。之后客户端进入 SYN_SEND 状态等待服务器确认。
2. 第二次握手：服务器收到 SYN 报文段。服务器收到 SYN 报文段后，需要对请求连接进行确认，置 ACK 为 X + 1 ，置 SYN 为 1，Seq 为 Y，发送 ACK + SYN 报文段。之后服务器进入SYN_RECV状态。
3. 第三次握手：客户端收到服务器的 ACK + SYN 报文段。客户端将 ACK 设置为 Y + 1,向服务器发送ACK报文段。此后，客户端和服务器都进入 ESTABLISHED 状态，完成 TCP 三次握手。
建立 TCP 三次握手后，浏览器发起 HTTP 请求获取服务器响应的 HTML 文件。

### 浏览器解析HTML文件

{% asset_img browser_flow.png 呈现引擎的基本流程 %}

1. 浏览器呈现引擎将开始解析 HTML 文档，并将各标记逐个转换成“内容树"上的 DOM 节点
2. 浏览器呈现殷勤同时解析 CSS 文件及样式元素生成呈现树。不可见的如 head 元素，display 为 none 的元素是不会加到呈现树中。
3. 呈现树构建完毕后进入布局阶段，即为每个节点分配一个应出现在屏幕的具体位置。
4. 最后是绘制阶段，呈现引擎会遍历呈现树，由用户界面后端将每个节点绘制出来。

在这个过程中如遇到外部请求文件，如 link 元素中引用外部 CSS 文件或 script 元素中引用外部 js 文件，浏览器则会停下当前对 HTML 的解析对外部文件进行请求。
得到外部文件后浏览器再继续解析剩下的 HTML 文件。
可使用 defer 或将 script 元素放在 body 元素尾部提高网页解析速度以优化用户体验。

一般对 HTML 文件中引用的外部文件的请求，浏览器会对每个请求重新建立一个 TCP 连接，但各浏览器对并行请求数量也是有限制的，如 Chrome 最多只能并行 6 个 TCP 请求。因此如果当前网页引用了多个外部文件也只能最多同时请求 6 个文件，其他文件的请求也只能等到之前的文件返回后再进行。
HTTP1.1 默认设置头部的 connect 为 keep-alive，使得在一定时间内即使客户端及服务器的传输已经结束，TCP 连接也不会断开，这样可以使得在这段时间内他们之间的数据传输不需要再经过 TCP 三次握手的等待时间。

HPPT1.1 虽然支持 HTTP 管道化，即同一个 TCP 连接可以不用等到服务器响应发送多个 HTTP 请求。
但 HTTP1.1 管道化持续连接难以实现及不标准的代理容易导致管道化出现问题难以调试，现各大浏览器厂商要么不支持 pipelining 要么默认关闭 pipelining 机制，如 [chrome 并不提供打开 pipelining 的选项](https://www.chromium.org/developers/design-documents/network-stack/http-pipelining)。
可以使用现在大多浏览器会支持的 HTTP2.0 达到 HTTP1.1 管道化的效果。

