---
title: 网页请求过程
date: 2018-08-18
---
这是一篇根据自己对网页浏览过程理解的总结。一个浏览网页的过程涉及到了方方面面，希望能将自己理解的尽可能记录总结下来，主要为了以下两点：
一是通过总结网页请求过程发现易被攻击的方面并找到理解对应的防范方法，让自己在以后开发中更加注意这些方面来提高网页的安全性；
二是找到可以提高网络性能的地方，提高用户体验。

<!-- more -->

本文将以一个用户在家里第一次上网访问 www.baidu.com 为例对用户在浏览器中输入这个URL后到整个网页呈现给用户的这个过程进行剖析。
总体来说主要分为以下过程：
1. 主机使用UDP数据报向DNS服务器发送请求解析 www.baidu.com 对应的IP地址
    - 因用户是第一次上网，主机要先获取自己的动态IP地址及DNS服务器IP地址；
    - 获取DNS服务器IP地址后，主机要与其通信要先获取其MAC地址；
2. 主机与 www.baidu.com 对应IP地址的服务器建立TCP连接发起HTTP请求获得HTML文件
3. 浏览器解析渲染HTML文件
4. 主机继续请求其中引入的外部文件，浏览器根据外部文件继续渲染HTML文件以呈现整个网页给用户

### DHCP获取动态IP
局域网广播到DHCP服务器获取动态IP地址，并获取默认路由地址及DNS服务器地址。

1. 客户机以0.0.0.0为源IP地址，255.255.255.255为目标地址广播，广播信息包含客户机的MAC地址及计算机名称
2. DHCP服务器收到广播信息后，从IP池中选出空闲的IP地址，并以255.255.255.255为目标地址广播，广播信息还包含子网掩码、默认路由、租约期限及DHCP的服务器IP地址。
3. 同一个网络中可能会存在多个DHCP服务器，客户机将使用接收到的第一个DHCP服务器消息中的IP地址，并以0.0.0.0为源IP地址，255.255.255.255为目标地址广播发送ACK信息，广播信息包含选择的IP地址信息。
4. 被选中的DHCP服务器收到客户机发送的DHCP请求后，广播ACK消息向客户机及其他DHCP服务器确认该客户机可以使用其分配的IP地址，其他DHCP服务器收到消息后将收回之前分配的IP地址，客户机收到ACK消息后便可以将分配到的IP地址和网卡绑定。

如果是使用自动分配方式，第一次配置了IP地址之后便可以在合约期内一直使用该IP地址，一般会在合约期的50%时进行续约请求；如果使用动态分配方式，每次登录都要重新向DHCP服务器请求获取动态IP。

### ARP请求获取DNS服务器的MAC地址
ARP协议是以太网等数据链路层的基础协议，负责完成IP地址到硬件地址的映射。
以太网协议规定，同一个局域网中的一台主机要和另一台主机进行通信，必须知道目标主机的MAC地址。
1. 当主机在本机的ARP缓存表中没有找到目标IP的MAC地址，则广播发送ARP请求，请求解析DNS服务器的MAC地址。
2. 当DNS服务器收到ARP请求后，返回其MAC地址。并根据请求主机的IP地址和MAC地址建立ARP表。
3. 客户机收到来自DNS服务器的ARP响应后同样将DNS的IP地址和MAC地址的对应关系记录下来以建立ARP表。

### 像DNS服务器请求获取目标网址域名对应IP
1. 当主机需要向DNS服务器发送请求，首先在浏览器缓存中查找是否有目标网址的IP映射，若有则可以直接进行网络请求。
2. 若浏览器缓存中找不到对应的IP映射，操作系统则会在本机的hosts文件中查找目标网址的IP地址，找到则直接调用这个IP映射完成域名解析，并直接进行网络请求。
3. 当主机在本机hosts文件中找不到请求网址的IP地址，主机则需要向本地DNS服务器进行域名解析请求，若本地DNS服务器找到对应IP则返回。
4. 本地DNS服务器有可能是默认路由也有可能是ISP提供的DNS服务器，当其在本地缓存中找不到对应的IP映射时，便向根域名服务器进行DNS请求。全球的根域名服务器地址的数量被限制为13个，使用任播技术使得实际上的根域名服务器数量大大增加。
5. 之后的请求便是迭代的过程：
   - 根域名服务器会返回请求域名对应的权威顶级域名DNS服务器的IP并返回到本地DNS服务器，本地DNS服务器向对应的顶级域名DNS服务器进行DNS请求。仅被收录的顶级域名对应的权威顶级域名服务器能被根域名服务器查出。
   - 顶级服务器会返回请求域名对应的二级域名DNS服务器的IP并返回到本地DNS服务，本地DNS服务器向对应的二级域名DNS服务器进行DNS请求。
  如此重复下去直到本地DNS服务器查询到最终结果并返回给主机，此时主机才能通过域名访问目标网站。
  
### 主机跟目标主机建立TCP连接并发起HTTP请求获取网页内容
HTTP协议是基于TCP/IP协议，TPC协议提供可靠的连接服务，连接需要通过三次握手进行初始化。
1. 第一次握手:建立连接。客户端发送连接请求报文段，置SYN为1，Seq为X。之后客户端进入SYN_SEND状态等待服务器确认。
2. 第二次握手：服务器收到SYN报文段。服务器收到SYN报文段后，需要对请求连接进行确认，置ACK为X+1，置SYN为1，Seq为Y，发送ACK+SYN报文段。之后服务器进入SYN_RECV状态。
3. 第三次握手：客户端收到服务器的ACK+SYN报文段。客户端将ACK设置为Y+1,向服务器发送ACK报文段。此后，客户端和服务器都进入ESTABLISHED状态，完成TCP三次握手。
建立TCP三次握手后，浏览器发起HTTP请求获取服务器响应的HTML文件。

### 浏览器解析HTML文件

{% asset_img browser_flow.png 呈现引擎的基本流程 %}

1. 浏览器呈现引擎将开始解析HTML文档，并将各标记逐个转换成“内容树"上的DOM节点
2. 浏览器呈现殷勤同时解析CSS文件及样式元素生成呈现树。不可见的如head元素，display为none的元素是不会加到呈现树中。
3. 呈现树构建完毕后进入布局阶段，即为每个节点分配一个应出现在屏幕的具体位置。
4. 最后是绘制阶段，呈现引擎会遍历呈现树，由用户界面后端将每个节点绘制出来。

在这个过程中如遇到外部请求文件，如link元素中引用外部CSS文件或script元素中引用外部js文件，浏览器则会停下当前对HTML的解析对外部文件进行请求。
得到外部文件后浏览器再继续解析剩下的HTML文件。
可使用defer或将script元素放在body元素尾部提高网页解析速度以优化用户体验。

一般对HTML文件中引用的外部文件的请求，浏览器会对每个请求重新建立一个TCP连接，但各浏览器对并行请求数量也是有限制的，如Chrome最多只能并行6个TCP请求。因此如果当前网页引用了多个外部文件也只能最多同时请求6个文件，其他文件的请求也只能等到之前的文件返回后再进行。
HTTP1.1默认设置头部的connect为keep-alive，使得在一定时间内即使客户端及服务器的传输已经结束，TCP连接也不会断开，这样可以使得在这段时间内他们之间的数据传输不需要再经过TCP三次握手的等待时间。

HPPT1.1虽然支持HTTP管道化，即同一个TCP连接可以不用等到服务器响应发送多个HTTP请求。
但HTTP1.1管道化持续连接难以实现及不标准的代理容易导致管道化出现问题难以调试，现各大浏览器厂商要么不支持pipelining要么默认关闭pipelining机制，如[chrome并不提供打开pipelining的选项](https://www.chromium.org/developers/design-documents/network-stack/http-pipelining)。
可以使用现在大多浏览器会支持的HTTP2.0达到HTTP1.1管道化的效果。

